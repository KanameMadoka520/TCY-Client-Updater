# TCY Client Updater (原 TCYServer_MCUpdater)

![Version](https://img.shields.io/badge/version-1.0.1-blue) ![Author](https://img.shields.io/badge/author-KanameMadoka520-purple) 
![Author](https://img.shields.io/badge/author-LainElaina-purple) 
[![License](https://img.shields.io/badge/license-CC%20BY--NC--SA%204.0-green)](https://github.com/KanameMadoka520/TCY-Client-Updater/blob/main/LICENSE)

本工具是将原本简易的更新脚本重构为专业级GUI应用程序的产物。专为糖醋鱼神人服务器的Minecraft【异界战斗幻想】整合包（糖醋鱼神人服务器使用并魔改自0.3.4版）客户端打造，方便后续继续给玩家提供一键更新客户端的方式（呜呜呜世界上有这么好的腐竹吗？自费开顶级服+买线路，还自己写更新器x）

底层架构采用 **pywebview**，结合 **前后端分离** 的设计理念，利用 HTML5/CSS3 技术栈渲染界面，提供了高度可定制的视觉效果与严谨的安全校验机制。

未来有可能进行大量重构和更新，可能会推出远超“更新器”范畴的功能，取决于开发者（KanameMadoka520和LainElaina）的开发计划。

如果您是Minecraft玩家且拥有一定的常识，欢迎您申请加入糖醋鱼神人服务器，本服仅对少量人开放，服务器技术在线，有自研脚本mod，配置强大（9950X3D），存档会一直迁移继承建筑而不丢弃，服务器文件定期备份到多种网盘，您的肝度会永久保存。
糖醋鱼服务器官网，以下均可：

https://cn.tcymc.space

https://tcymc.space

## 核心技术架构与原理

本项目采用轻量级混合开发模式，引入了 **“序列化队列”**、**“智能补票”** 与 **“High-DPI 自适应”** 架构：

### 1. 前后端分离与主动握手

* **前端 (View)**: `index.html` 负责界面交互。全面采用 **SVG 矢量图标**，引入 **动态粒子系统 (Particle System)** 与 **CSS3 故障风 (Glitch)** 特效，提升视觉专业度。
* **后端 (Model)**: `TCYServer_MCUpdater.py` 负责核心逻辑（文件IO、系统调用、Win32 API交互）。
* **通信机制**: 采用 **前端主动握手** 模式。前端 DOM 加载完毕后通知后端，后端再注入初始化数据，解决界面“未响应”或死锁问题。

### 2. 骨肉分离与动态加速

* **骨 (Skeleton)**: 极小的 `update.zip`（仅含配置、脚本、清单），托管在 GitHub/Cloudflare，实现秒级响应。
* **肉 (Flesh)**: 大体积模组文件（Jar）托管于 GitHub Release，通过清单索引。
* **动态镜像**: 针对 CN 线路，后端会自动拦截 GitHub 请求并动态拼接镜像前缀（如 `gh-proxy`），实现国内外双线高速更新。

### 3. 序列化状态同步

* **智能队列机制**: 更新不再是简单的“覆盖最新版”。系统会自动计算你当前版本与最新版本之间**缺失的所有更新**，并将它们构建为一个按时间排序的队列。
* **批量原子化执行**: 用户确认后，程序会自动**依次**下载并安装队列中的每一个版本，确保没有任何中间补丁被遗漏（告别“跳版本”导致的文件缺失）。

### 4. 双轨版本控制机制

* **启动器自更新**: 支持语义化版本（如 `1.0.0`），采用 UTF-8 批处理脚本，**自适应保留用户重命名后的文件名**（即使是包含 Emoji 的怪异名字）。
* **内容更新**: 采用时间戳版本（如 `26.02.06.15.53`），支持增量更新与可选内容的“补票”机制。

### 5. 高分屏适配与配置持久化

* **High-DPI 完美适配**: 后端通过 `windll.user32` 直接调用 Win32 API，自动计算物理像素与逻辑像素的比例。无论是在 1080P 还是 4K 屏幕下，窗口大小调整均精确到像素级，避免模糊。
* **JSON 存储**: 所有设置（背景、模糊度、字体、分辨率预设、镜像源）及跳过的版本记录均持久化存储。

## 功能特性

### 🛡️ 安全与校验 (Safety & Verification)

* **启动前置强校验**:
    * 程序启动时会自动进行深度目录扫描。
    * **严格路径检测**: 强制检查相对路径 `.minecraft/versions/异界战斗幻想` 是否存在。
    * **防呆拦截**: 若未检测到正确路径（如用户将更新器误放在桌面），将弹出警告窗口阻断进入，防止文件解压错乱（支持知道自己在做什么的用户强制跳过）。

### 🛡️ 智能更新系统 (Smart Update)

* **可视化进度反馈**:
    * 实时显示 **下载速度 (MB/s, KB/s)**。
    * 精确显示当前正在处理的文件名及该文件的下载百分比。
* **可选更新与补票**:
    * **可选 (Optional)**: 针对非强制性内容（如辅助模组），提供复选框，可选择跳过。
    * **补票机制 (Catch-up)**: 系统会记住你跳过的可选更新。下次检查时，它依然会出现在列表中提醒你”补票”，直到安装为止。
* **强制更新锁定**: 涉及服务器连接的核心更新将被锁定为”必选”。
* **强制拉取历史版本**:
    * 更新页面提供”强制拉取历史版本”按钮，用于你明确知道操作目的、想要强制重新应用某一次历史更新的情况。
    * 无需手动修改 `launcher_settings.json` 中的版本号，直接从列表中选择目标版本即可。
    * 点击后会列出所有历史版本供单选，选定后再点击更新才会执行，不会误触。
* **综合版本信息弹窗**: 检查更新时，客户端版本信息与更新器版本信息统一在同一弹窗中展示，同时显示各来源地址的获取结果。

### 🚀 快捷工具箱 (Shortcuts)

专为提升游戏体验设计的快捷入口，只有当程序正确识别到客户端目录时才可用：

* **材质包管理**: 直接打开 `.../resourcepacks`。
* **光影包管理**: 直接打开 `.../shaderpacks`。
* **截图浏览**: 直接打开 `.../screenshots`。

### 📂 增强型文件管理

* **Mods / Config 管理**:
    * **正则搜索支持 (Regex Search)**: 搜索框支持正则表达式（如输入 `jei|map`），并自动高亮匹配的文件夹和文件。
    * **二级删除防护**: 删除操作需二次确认，防止误操作。
    * **双击编辑**: Config 文件支持双击直接调用系统默认编辑器打开。

### 🌐 多线路官网集成

内置“神人服务器官方网站”页面，针对不同网络环境优化：

* **双线路支持**: 所有资源下载、日志查看均提供 **CN加速 (国内)** 和 **全球 (Global)** 两个入口。
* **外部仓库链接**: 增加了跳转至 GitHub 源码仓库及更新文件公示仓库的快捷入口。

### 🔗 自定义更新源与多源容错 (Custom Update Source & Fallback)

* **多源自动轮询**:
    * 程序启动时会自动按优先级依次尝试以下地址获取版本信息：**自定义地址（若填写）→ 官网默认地址 → GitHub 备用地址 → GitHub 加速前缀地址**。
    * 只要有任意一个地址成功响应，即可正常使用，无需用户手动干预。
    * 仅当所有地址均无法访问时，才会弹出错误提示，并列出已尝试的全部地址。
    * 若部分地址失败但有地址成功，弹窗会明确提示哪些地址失败、最终从哪个地址获取成功。
* **GitHub 备用地址**:
    * 内置 GitHub Release 作为官网的备用来源，国内用户同时尝试加速前缀地址，有效应对官网偶发性不可用的情况。
* **备用链接支持**:
    * 用户可在"个性化设置"中填写自定义的 JSON 地址，优先级最高。
    * 支持分别自定义 **客户端版本 JSON (latest.json)** 和 **更新器版本 JSON (Updater-latest.json)** 的拉取地址。
* **默认提示**:
    * 输入框中会以 placeholder 形式提示原本默认的拉取网址，方便用户对照。
    * 留空即使用默认地址，无需额外操作。
* **一键恢复默认**:
    * 自定义更新源卡片内提供"恢复默认更新源"按钮，点击后立即将两个 JSON 地址恢复为程序内置默认值。
* **持久化保存**:
    * 自定义地址与其他设置统一保存在 `launcher_settings.json` 中，重启后自动生效。

### 🎨 深度个性化系统

* **视觉特效**:
    * **动态粒子**: 背景集成基于 HTML5 Canvas 的漂浮粒子系统，颜色随主题色自动变化。
    * **故障风 (Glitch)**: 标题栏采用赛博朋克风格的故障抖动效果。
    * **毛玻璃 (Glass)**: 支持遮罩透明度和模糊度无级调节。
* **主题定制**:
    * **字体切换**: 支持 Segoe UI, 微软雅黑, 宋体, Consolas 等多种字体。
    * **配色方案**: 内置 5 种主色调（Accent Color）及多种文字颜色预设。
* **窗口控制**:
    * **分辨率预设**: 提供从 950x600 到 2K (2560x1440) 的多种逻辑分辨率选择，自动适配屏幕缩放。
    * **背景自定义**: 支持导入本地图片或恢复默认。

## 推荐目录结构

为了通过启动时的**强制目录校验**，请务必保持以下目录结构（即：更新器必须与 HMCL/PCL 等启动器放在同一级）：

```text
您的游戏整合包文件夹 (名称可自定义)/
├── TCYClientUpdater-1.0.0.exe           <-- 【关键】必须放在这里，与 .minecraft 同级
├── launcher_settings.json           <-- (自动生成) 配置文件
├── launcher_debug.log               <-- (自动生成) 运行日志
├── .minecraft/                      <-- 游戏核心数据目录
│   ├── versions/
│   │   └── 异界战斗幻想/            <-- 【关键】校验目标，必须存在此文件夹
│   │       ├── mods/               <-- Mods管理页读取此处
│   │       ├── config/             <-- Config管理页读取此处
│   │       ├── resourcepacks/
│   │       ├── shaderpacks/
│   │       └── screenshots/
│   └── ...
└── update_*.zip                     <-- (可选) 手动下载的离线包

```

---

## 🛠️ 部署与适配指南——打造你自己的更新器

如果你想把这个更新器修改适配到你自己的 Minecraft 服务器（非 TCY 服务器），请严格按照以下步骤，从上到下逐一修改。

### 第一阶段：准备工作

1. **安装 Python 环境**

* 确保你的电脑安装了 Python 3.x。
* 安装必要的依赖库，打开终端（CMD）输入：

```bash
pip install pywebview pyinstaller

```

2. **准备素材**

* **图标 (`icon.ico`)**: 找一个 `.ico` 格式的图片，放在代码同级目录下，作为程序图标。
* **背景图 (`background.png`)**: 找一张好看的图片（建议 1920x1080），命名为 `background.png` 放在同级目录。这是默认背景。

### 第二阶段：修改核心逻辑 (`TCYServer_MCUpdater.py`)

打开 `TCYServer_MCUpdater.py`，搜索并修改以下内容：

1. **修改目标版本文件夹名称 (必改!)**

* 找到代码开头部分的变量：`TARGET_VERSION_NAME = "异界战斗幻想"`
* **要做的事**: 把 `"异界战斗幻想"` 改成你整合包 `.minecraft/versions/` 下面那个文件夹的名字。
* *例子*: 如果你的整合包版本文件夹叫 `浩哥可爱捏`，就改成 `"浩哥可爱捏"`。

2. **修改初始版本号**

* 找到：`INITIAL_VERSION = "26.02.06.15.24"`
* **要做的事**: 改成你当前的客户端版本号。糖醋鱼个人建议你使用日期格式以免混淆。

3. **修改在线更新源 (最重要!)**

* 默认的更新源地址现在定义为文件顶部的常量，你需要修改它们（你需要一个可以托管 JSON 文件的网站，比如 GitHub Pages、Cloudflare Pages 或者你自己的服务器）。
* **搜索**: 文件顶部的 `DEFAULT_UPDATER_JSON_URL`
* 原文：`DEFAULT_UPDATER_JSON_URL = “https://tcymc.space/update/Updater-latest.json”`
* **改为**: 你存放”更新器自身版本信息”的 JSON 链接。
* **搜索**: 文件顶部的 `DEFAULT_LATEST_JSON_URL`
* 原文：`DEFAULT_LATEST_JSON_URL = “https://tcymc.space/update/latest.json”`
* **改为**: 你存放”游戏内容更新信息”的 JSON 链接。
* **注意**: 用户也可以在”个性化设置 > 自定义更新源”中覆盖这些默认地址，无需修改代码。

4. **修改 User-Agent (可选)**

* 搜索 `User-Agent`，把里面的 `TCYClientUpdater/1.0` 改成你自己的名字，防止和原版混淆。

### 第三阶段：修改界面 (`index.html`)

打开 `index.html`，这是用户看到的样子，需要把“糖醋鱼”的痕迹抹除。

1. **标题与品牌**

* 搜索 `<title>TCY Client Updater</title>` -> 改成你的标题。
* 搜索 `TCY Client Updater` (在 `<div class="brand">` 里) -> 改成你的启动器名字。

2. **侧边栏与链接**

* 找到侧边栏的按钮配置（`nav-item`），特别是 `#nav-web` 部分：
* **搜索**: `神人服务器官方网站` -> 改成你的官网名字。
* **搜索**: `tcymc.space` -> 这里面所有的网址都要换成你自己的官网链接。

3. **提示文案**

* 代码里有很多写给玩家的提示，搜索以下关键词并修改：“糖醋鱼神人服务器”、“HMCL更新器”、“异界战斗幻想”、“QQ群反馈”。

4. **默认镜像源**

* 搜索 `<input type="text" id="mirror-prefix-input"`：把 `placeholder` 和 `value` 里的 `https://gh-proxy.org/` 改成你推荐的镜像源。

### 第四阶段：构建配置 (`build.py`)

打开 `build.py`，决定打包出来的 EXE 文件叫什么。

1. **修改程序名称**

* 找到：`EXE_NAME = "TCYClientUpdater-1.0.0"`
* **要做的事**: 改成你想要的程序名字，比如 `"终末地客户端更新器"`。

### 第五阶段：服务端搭建 (核心)

你的代码里填写的那些 JSON 链接（在第二阶段第3步），必须真实存在，并且内容格式要正确。你需要准备两个 JSON 文件上传到你的网站。

**1. 游戏内容更新 JSON (`latest.json`)**
格式必须如下：

```json
{
  "history": [
    {
      "version": "26.02.10.00.00",
      "date": "2026-02-10",
      "desc": "这里写更新日志：\n1. 修复了Bug\n2. 增加了Mod",
      "opt_update": false,
      "download_urls": {
        "cn": "https://你的网站/download/update_v2.zip",
        "global": "https://你的网站/download/update_v2.zip"
      }
    }
  ]
}

```

**2. 更新器自身更新 JSON (`Updater-latest.json`)**
格式必须如下：

```json
{
  "version": "1.0.1",
  "desc": "更新器自我升级：修复了闪退问题",
  "url": "https://你的网站/download/NewUpdater.exe"
}

```

### 第六阶段：打包发布

1. 确保 `icon.ico`, `background.png`, `index.html`, `tcy_assets.py` 都在文件夹里。
2. 在终端运行：

```bash
python build.py

```

3. 等待运行完成，去新生成的 `dist` 文件夹里，把那个 `.exe` 文件发给你的玩家。

### ⚠️ 适配避坑指南

1. **目录结构必须对**: 你的这个更新器有**强校验逻辑**。告诉你的玩家，必须把 `.exe` 放在和 `.minecraft` 文件夹**同级**的地方，否则不能正常完成客户端更新！
2. **HTTPS 问题**: 代码中已经添加了忽略 SSL 证书验证 (`ssl._create_unverified_context`)，所以即使用自签名的证书一般也没问题，但最好还是用正规的 HTTPS 链接。
3. **不要删 `index.html**`: 虽然打包脚本把它打进去了，但在打包前，它必须存在。

---

## 故障排查

* **启动时弹出“目录结构校验失败”**:
* 原因：更新器未检测到 `.minecraft/versions/异界战斗幻想` 路径。
* 解决：请确保将更新器 EXE 放在游戏整合包的根目录下（和 `.minecraft` 文件夹在同一层）。
* **更新器改名后无法自动更新**:
* 现已修复。本版本支持任意改名（包括含 Emoji 的名字），更新后会自动保持您修改后的名字。
* **为什么有旧版本提示?**:
* 如果你之前跳过了某个可选更新，系统会一直将其保留在更新队列中，属于“补票机制”的正常现象。
* **CN线路下载失败**:
* 请在”个性化设置”中更改”GitHub 镜像加速前缀”（推荐 `https://gh-proxy.org/`）。
* **无法连接主站获取版本信息**:
* 程序会自动依次尝试官网、GitHub 备用地址、GitHub 加速前缀地址，通常无需手动干预。若所有地址均失败，弹窗会列出已尝试的全部地址。此时可在”个性化设置 > 自定义更新源”中填写管理员提供的备用 JSON 地址，或检查”GitHub 镜像加速前缀”是否有效。留空则使用默认地址，点击”恢复默认更新源”可一键恢复。
* **程序未响应**:
* 查看同级目录下的 `launcher_debug.log` 或 `CRASH_IMPORT.txt` 获取堆栈信息。

## 📜 开源协议 (License)

本项目采用 **[CC BY-NC-SA 4.0 (知识共享-署名-非商业性使用-相同方式共享 4.0 国际)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)** 协议进行许可。

### ✅ 根据该协议，本项目允许你做的事情：

* **分享**：你可以在任何媒介以任何形式复制、发行本作品（例如：分享给朋友、在你的免费服务器群里分发）。
* **修改/演绎**：你可以查看源代码，修改代码，或以本作品为基础进行二次创作（例如：修改 UI、增加新功能）。
* **学习与研究**：你可以无限制地阅读代码用于学习 Python、PyWebview 或前端技术。

### ❌ 根据该协议，本项目不允许你做的事情：

* **商业性使用 (严禁)**：**你不得将本作品用于任何商业目的**。
* 包括但不限于：将本启动器打包在付费整合包中、作为付费服务器的专用客户端、在软件内植入未经过项目作者许可的商业广告、或者出售本软件的修改版。
* **闭源发布**：如果你修改了本软件并发布，你**必须**使用相同的协议（CC BY-NC-SA 4.0）开源你的修改版本，不能将修改后的代码闭源。
* **不署名**：你在分发或修改版本时，必须保留原作者（KanameMadoka520和LainElaina）的署名和版权声明。

---

*如果您希望将本软件用于商业用途，请务必联系作者（KanameMadoka520和LainElaina）获得单独授权。*

---

## 🗓️ 更新计划 (Roadmap)

### ✅ 已实现

* **更新日志历史浏览 (时间线视图)**：拉取 `latest.json` 后自动缓存历史记录到本地 `launcher_settings.json`，侧边栏新增"更新日志"页面，以时间线形式展示所有版本变更，无需重复联网。
* **镜像加速源推荐**：在个性化设置的镜像加速前缀区域，新增多个对中国境内友好的常用 GitHub 镜像源快捷按钮，点击即可填入。
* **版本 JSON 可视化编辑工具**：新增 `VersionJsonEditor/` 独立工具项目，支持在浏览器中可视化编辑 `latest.json` 和 `Updater-latest.json`，方便服务器管理员发布更新。

### 🔮 未来计划

* **断点续传**：大文件下载中断后支持从上次位置继续，避免重头下载。需要 HTTP Range 请求支持。
* **文件完整性校验 (SHA256/MD5)**：替代当前仅依赖文件大小的判断方式，防止下载损坏或被篡改。
* **更新回滚机制**：更新前自动备份被修改的文件，更新失败时可一键恢复到上一个版本。
* **多语言支持 (i18n)**：将 UI 文案抽离为语言包，方便其他服务器适配不同语言。
* **系统托盘最小化**：关闭窗口时缩到系统托盘而非直接退出，方便后台等待下载完成。
* **并行下载**：多个 external_files 开多线程并行下载，提升大量模组文件的更新速度。
* **下载限速**：提供可配置的带宽限制，避免更新时占满用户网络。
* **CDN/镜像源自动测速**：启动时自动测试多个镜像源延迟，自动选择最快的源。
* **SSL 证书验证优化**：仅对特定内网地址跳过 SSL 验证，其他地址走正常验证流程。
* **更新包签名验证**：对下载的 ZIP 包进行数字签名校验，防止中间人攻击。
* **自动错误上报**：崩溃或更新失败时可选地将日志摘要发送到服务端，方便排查问题。
* **插件/模组冲突检测**：更新前扫描现有 mods 文件夹，检测已知的不兼容模组组合并提醒玩家。
